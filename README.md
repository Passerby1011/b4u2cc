# cc-proxy - Claude Code ä»£ç†æœåŠ¡å™¨

[![Deno](https://img.shields.io/badge/deno-v1.40+-00ADD8?logo=deno)](https://deno.land/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

cc-proxy æ˜¯ä¸€ä¸ªåŸºäº Deno çš„æ™ºèƒ½ä»£ç†æœåŠ¡å™¨ï¼Œé€šè¿‡"æç¤ºè¯æ³¨å…¥ + XML æ ‡ç­¾æ¨¡æ‹Ÿ"æœºåˆ¶ï¼Œè®©ä¸æ”¯æŒåŸç”Ÿå·¥å…·è°ƒç”¨çš„ AI æ¨¡å‹ä¹Ÿèƒ½å®Œç¾æ”¯æŒ Claude Code çš„å·¥å…·è°ƒç”¨èƒ½åŠ›ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [æ–‡æ¡£ç´¢å¼•](#æ–‡æ¡£ç´¢å¼•)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [è´¡çŒ®æŒ‡å—](#è´¡çŒ®æŒ‡å—)
- [è®¸å¯è¯](#è®¸å¯è¯)

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ ¸å¿ƒç»„ä»¶ä¸º `deno-proxy`ï¼Œå®ƒåœ¨ Claude Code å®¢æˆ·ç«¯ä¸ä¸Šæ¸¸ AI æœåŠ¡ä¹‹é—´å»ºç«‹äº†ä¸€å¥—é«˜åº¦è§£è€¦çš„æµæ°´çº¿ã€‚æ— è®ºä¸Šæ¸¸ä½¿ç”¨ä½•ç§åè®®ï¼Œåªè¦å®ƒèƒ½ç†è§£å¹¶éµå¾ª Prompt æŒ‡ä»¤ï¼Œå°±èƒ½é€šè¿‡æœ¬ä»£ç†è·å¾—å·¥å…·è°ƒç”¨æ”¯æŒã€‚

### ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹© cc-proxyï¼Ÿ

- **çªç ´é™åˆ¶**: è®©ä¸æ”¯æŒå·¥å…·è°ƒç”¨çš„ä¾¿å®œæ¸ é“ä¹Ÿèƒ½è¿è¡Œ Claude Code
- **ç»Ÿä¸€ä½“éªŒ**: æ— è®ºåç«¯æ˜¯ GPT-4ã€Claude è¿˜æ˜¯å…¶ä»–æ¨¡å‹ï¼Œå®¢æˆ·ç«¯ä½“éªŒå®Œå…¨ä¸€è‡´
- **æç®€ç»´æŠ¤**: é‡‡ç”¨æµæ°´çº¿æ¶æ„ï¼Œæ–°å¢åè®®ä»…éœ€å®ç°å°‘é‡ä»£ç 
- **çµæ´»é…ç½®**: æ”¯æŒå¤šæ¸ é“åŠ¨æ€åˆ‡æ¢ï¼Œä¸€å¥—é…ç½®ç®¡ç†æ— é™æ¨¡å‹

### ğŸš€ æ ¸å¿ƒæ¶æ„ï¼šå¢å¼ºä¸å¹³ç§»

æ–°ç‰ˆé‡‡ç”¨äº†"å…ˆå¢å¼ºï¼Œåå¹³ç§»"çš„å…ˆè¿›æ¶æ„ï¼š

1. **Enrichment (æ³¨å…¥å¢å¼º)**: ç»Ÿä¸€åœ¨ Claude è¯·æ±‚å±‚é¢å°†å·¥å…·å®šä¹‰å’Œå†å²æ¶ˆæ¯æ–‡æœ¬åŒ–
2. **Routing & Translation (è·¯ç”±ä¸å¹³ç§»)**: æ ¹æ®é…ç½®å°†"å¢å¼ºå"çš„è¯·æ±‚é€æ˜æ˜ å°„åˆ° OpenAI æˆ– Anthropic åŸç”Ÿåè®®
3. **Unified Streaming (ç»Ÿä¸€æµè§£æ)**: æ— è®ºä¸Šæ¸¸è¿”å›ä½•ç§ SSE æ ¼å¼ï¼Œå‡ç”±ç»Ÿä¸€çš„ Parser è¯†åˆ«å·¥å…·è¾¹ç•Œï¼Œå¹¶ç”±ç»Ÿä¸€çš„ Writer ç”Ÿæˆæ ‡å‡† Claude å“åº”

## æ ¸å¿ƒç‰¹æ€§

### ğŸ› ï¸ åè®®ä¸æ¨¡å‹æ”¯æŒ

- âœ… **å¤šåè®®æ”¯æŒ**: åŸç”Ÿæ”¯æŒä¸Šæ¸¸ä¸º OpenAI æ ¼å¼æˆ– Anthropic æ ¼å¼
- âœ… **å·¥å…·è°ƒç”¨æ¨¡æ‹Ÿ**: å³ä½¿æ¨¡å‹ä¸æ”¯æŒåŸç”Ÿ Function Callingï¼Œä¹Ÿèƒ½é€šè¿‡æ³¨å…¥çš„ XML æŒ‡ä»¤ç²¾å‡†è§¦å‘å·¥å…·
- âœ… **æ€è€ƒæ¨¡å¼ (Thinking)**: å®Œç¾æ”¯æŒå¹¶è½¬æ¢æ€è€ƒå—ï¼Œå…¼å®¹æœ€æ–°çš„æ€ç»´é“¾æ¨¡å‹
- âœ… **æµå¼å“åº”**: å®Œæ•´çš„ SSE æµå¼å¤„ç†ï¼Œå®æ—¶è¿”å›ç»“æœ

### ğŸ”„ æ¸ é“ä¸è·¯ç”±

- âœ… **åŠ¨æ€æ¸ é“åˆ‡æ¢**: æ”¯æŒ `æ¸ é“å+æ¨¡å‹å` æ ¼å¼ï¼Œä¸€å¥—é…ç½®æ”¯æŒæ— é™æ¨¡å‹
- âœ… **å¤šæ¸ é“é…ç½®**: é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®å¤šä¸ªä¸Šæ¸¸æœåŠ¡ï¼Œçµæ´»åˆ‡æ¢
- âœ… **æ™ºèƒ½è·¯ç”±**: æ ¹æ®æ¨¡å‹åè‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„ä¸Šæ¸¸æ¸ é“

### ğŸ” å®‰å…¨ä¸è®¤è¯

- âœ… **API Key é€ä¼ **: æ”¯æŒå®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„ API å¯†é’¥è¿›è¡Œä¸Šæ¸¸è®¤è¯
- âœ… **è®¿é—®æ§åˆ¶**: å¯é…ç½®å®¢æˆ·ç«¯ API Key éªŒè¯
- âœ… **é€Ÿç‡é™åˆ¶**: å†…ç½®è¯·æ±‚é¢‘ç‡æ§åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨

### ğŸ“Š ç›‘æ§ä¸ç®¡ç†

- âœ… **ç®¡ç†åå° (Web UI)**: æä¾›ç®€æ´ç¾è§‚çš„å¯è§†åŒ–é…ç½®ç®¡ç†ç•Œé¢ï¼Œæ”¯æŒåœ¨çº¿ä¿®æ”¹æ¸ é“ã€åè®®ç­‰æ‰€æœ‰é…ç½®
- âœ… **çµæ´»å­˜å‚¨æ–¹æ¡ˆ**: æ”¯æŒæœ¬åœ° JSON æ–‡ä»¶æˆ–è¿œç¨‹ PostgreSQL æ•°æ®åº“æŒä¹…åŒ–é…ç½®
- âœ… **å®æ—¶åŒæ­¥**: æ”¯æŒä»å­˜å‚¨åç«¯æ‰‹åŠ¨é‡è½½é…ç½®ï¼Œæ— éœ€é‡å¯æœåŠ¡
- âœ… **Token è®¡æ•°**: ç²¾ç¡®çš„ tiktoken æœ¬åœ°è®¡æ•°ï¼Œæ”¯æŒ Claude API é›†æˆ
- âœ… **Token å€æ•°**: æ”¯æŒè‡ªå®šä¹‰å€æ•°è°ƒæ•´ï¼Œä¾¿äºè®¡è´¹ç®¡ç†
- âœ… **ç»“æ„åŒ–æ—¥å¿—**: è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—ï¼Œæ”¯æŒæŒ‰è¯·æ±‚ ID è¿½è¸ª
- âœ… **å¥åº·æ£€æŸ¥**: æä¾› `/healthz` ç«¯ç‚¹ç”¨äºæœåŠ¡ç›‘æ§

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Deno**: 1.40+ ([å®‰è£…æŒ‡å—](https://deno.land/manual/getting_started/installation))
- **æ“ä½œç³»ç»Ÿ**: Linuxã€macOS æˆ– Windows
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

### ä¸€é”®éƒ¨ç½²åˆ° Deno Deploy

æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ Deno Deploy ä¸€é”®éƒ¨ç½²ï¼š

```bash
# å®‰è£… deployctl
deno install -gArf jsr:@deno/deployctl

# ç™»å½•
deployctl login

# éƒ¨ç½²é¡¹ç›®
deployctl deploy --project=cc-proxy deno-proxy/src/main.ts
```

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ [Deno Deploy éƒ¨ç½²æŒ‡å—](docs/deno-deployment-guide.md)ã€‚

### æœ¬åœ°è¿è¡Œ

1. **å…‹éš†é¡¹ç›®**

```bash
git clone https://github.com/Passerby1011/cc-proxy.git
cd cc-proxy
```

2. **å¯åŠ¨æœåŠ¡**

```bash
cd deno-proxy

# è®¾ç½®ç®¡ç†å‘˜å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
export ADMIN_API_KEY=your-secure-admin-key

# å¯é€‰ï¼šæŒ‡å®šç«¯å£å’Œæ—¥å¿—çº§åˆ«
export PORT=3456
export LOG_LEVEL=info

# å¯åŠ¨æœåŠ¡
deno run --allow-net --allow-env --allow-read --allow-write src/main.ts
```

3. **è®¿é—®ç®¡ç†åå°**

åœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://localhost:3456/admin`ï¼Œä½¿ç”¨ `ADMIN_API_KEY` ç™»å½•åå³å¯ï¼š

- é…ç½®ä¸Šæ¸¸æ¸ é“ï¼ˆæ”¯æŒå¤šä¸ª OpenAI/Anthropic å…¼å®¹æœåŠ¡ï¼‰
- è®¾ç½®å®¢æˆ·ç«¯ API å¯†é’¥éªŒè¯
- é…ç½®é€Ÿç‡é™åˆ¶ã€è¶…æ—¶æ—¶é—´ç­‰
- é€‰æ‹©æœ¬åœ°æ–‡ä»¶æˆ– PostgreSQL å­˜å‚¨
- æ‰€æœ‰é…ç½®å³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯

4. **æµ‹è¯•æœåŠ¡**

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3456/healthz

# æµ‹è¯•å·¥å…·è°ƒç”¨ï¼ˆå‡è®¾å·²åœ¨ç®¡ç†åå°é…ç½®äº†åä¸º my_openai çš„æ¸ é“ï¼‰
curl -X POST http://localhost:3456/v1/messages \
  -H "Content-Type: application/json" \
  -H "x-api-key: your-client-api-key" \
  -d '{
    "model": "my_openai+gpt-4o",
    "messages": [{"role": "user", "content": "What is the weather?"}],
    "tools": [{"name": "get_weather", "description": "Get weather", "input_schema": {"type": "object", "properties": {"city": {"type": "string"}}}}],
    "max_tokens": 1024
  }'
```

## é…ç½®è¯´æ˜

### ç®¡ç†åå° (Web UI) - æ¨èæ–¹å¼

æ–°ç‰ˆæœ¬æä¾›äº†å¯è§†åŒ–çš„ç®¡ç†åå°ï¼Œè¿™æ˜¯**æ¨èçš„é…ç½®æ–¹å¼**ã€‚

#### è®¿é—®ç®¡ç†åå°

1. **å¯åŠ¨æœåŠ¡æ—¶è®¾ç½®ç®¡ç†å‘˜å¯†é’¥**ï¼ˆå¿…éœ€ï¼‰

```bash
export ADMIN_API_KEY=your-secure-admin-key
deno run --allow-net --allow-env --allow-read --allow-write src/main.ts
```

2. **åœ¨æµè§ˆå™¨ä¸­è®¿é—®** `http://localhost:3456/admin`

3. **ä½¿ç”¨ ADMIN_API_KEY ç™»å½•**

#### ç®¡ç†åå°åŠŸèƒ½

é€šè¿‡ Web UIï¼Œæ‚¨å¯ä»¥ç›´è§‚åœ°é…ç½®æ‰€æœ‰é€‰é¡¹ï¼š

##### ğŸ“¡ æ¸ é“ç®¡ç†
- **æ·»åŠ /åˆ é™¤æ¸ é“**: æ”¯æŒé…ç½®å¤šä¸ªä¸Šæ¸¸æœåŠ¡ï¼ˆOpenAIã€Anthropic æˆ–å…¶ä»–å…¼å®¹ APIï¼‰
- **æ¸ é“é…ç½®é¡¹**:
  - `æ¸ é“æ ‡è¯†`: ç”¨äºå®¢æˆ·ç«¯æ¨¡å‹åå‰ç¼€ï¼ˆå¦‚ `my_openai`ï¼‰
  - `Base URL`: ä¸Šæ¸¸ API åœ°å€
  - `API Key`: ä¸Šæ¸¸æœåŠ¡çš„å¯†é’¥ï¼ˆå¯é€‰ï¼Œæ”¯æŒå®¢æˆ·ç«¯é€ä¼ ï¼‰
  - `åè®®ç±»å‹`: `openai` æˆ– `anthropic`

##### âš™ï¸ ç³»ç»Ÿé…ç½®
- **ç½‘ç»œè®¾ç½®**: æœåŠ¡ç«¯å£ã€ç»‘å®šåœ°å€ã€è¯·æ±‚è¶…æ—¶
- **å®‰å…¨æ§åˆ¶**: å®¢æˆ·ç«¯ API å¯†é’¥éªŒè¯ã€é€Ÿç‡é™åˆ¶ï¼ˆRPMï¼‰
- **Token ç®¡ç†**: Token ä»·æ ¼ä¹˜æ•°ã€æ˜¯å¦é€ä¼ å®¢æˆ·ç«¯å¯†é’¥
- **æ•°æ®å­˜å‚¨**: é€‰æ‹©æœ¬åœ°æ–‡ä»¶æˆ– PostgreSQL æ•°æ®åº“

##### ğŸ’¾ é…ç½®æŒä¹…åŒ–
- **æœ¬åœ°æ–‡ä»¶æ¨¡å¼**: é…ç½®ä¿å­˜åˆ° `config.json`ï¼ˆé»˜è®¤ï¼‰
- **PostgreSQL æ¨¡å¼**: è®¾ç½® `PGSTORE_DSN` åä½¿ç”¨æ•°æ®åº“å­˜å‚¨
- **å®æ—¶åŒæ­¥**: ç‚¹å‡»"åŒæ­¥æ•°æ®"æŒ‰é’®å¯ä»å­˜å‚¨åç«¯é‡æ–°åŠ è½½é…ç½®

### å®¢æˆ·ç«¯ä½¿ç”¨æ–¹å¼

é…ç½®å¥½æ¸ é“åï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ¨¡å‹æ—¶ä½¿ç”¨ `æ¸ é“å+æ¨¡å‹å` æ ¼å¼ï¼š

```bash
# ç¤ºä¾‹ï¼šä½¿ç”¨åä¸º my_openai çš„æ¸ é“è®¿é—® gpt-4o æ¨¡å‹
curl -X POST http://localhost:3456/v1/messages \
  -H "Content-Type: application/json" \
  -H "x-api-key: your-client-api-key" \
  -d '{
    "model": "my_openai+gpt-4o",
    "messages": [{"role": "user", "content": "Hello"}],
    "max_tokens": 1024
  }'
```

**æ¨¡å‹åæ ¼å¼è¯´æ˜**:
- `æ¸ é“å+æ¨¡å‹å`: ä½¿ç”¨æŒ‡å®šæ¸ é“ï¼Œå¦‚ `my_openai+gpt-4o`
- ä»…æ¨¡å‹å: ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æ¸ é“

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆé«˜çº§ï¼‰

å¯¹äºè‡ªåŠ¨åŒ–éƒ¨ç½²æˆ–å®¹å™¨åŒ–åœºæ™¯ï¼Œä»æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼š

| ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|--------|------|
| `ADMIN_API_KEY` | - | **å¿…éœ€** - ç®¡ç†åå°ç™»å½•å¯†é’¥ |
| `PORT` | `3456` | æœåŠ¡ç›‘å¬ç«¯å£ |
| `HOST` | `0.0.0.0` | æœåŠ¡ç»‘å®šåœ°å€ |
| `LOG_LEVEL` | `info` | æ—¥å¿—çº§åˆ«ï¼ˆdebug/info/warn/errorï¼‰ |
| `PGSTORE_DSN` | - | PostgreSQL è¿æ¥å­—ç¬¦ä¸²ï¼Œå¦‚ `postgresql://user:pass@host:port/db` |
| `CONFIG_FILE_PATH` | `config.json` | æœ¬åœ°é…ç½®æ–‡ä»¶è·¯å¾„ |

> ğŸ’¡ **æç¤º**: 
> - é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œå¯é€šè¿‡ç®¡ç†åå°å®Œæˆæ‰€æœ‰é…ç½®
> - é…ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ï¼Œä¸‹æ¬¡å¯åŠ¨è‡ªåŠ¨åŠ è½½
> - ç¯å¢ƒå˜é‡ä¸­çš„é…ç½®é¡¹ä¼šè¦†ç›–å­˜å‚¨ä¸­çš„ç›¸åŒé…ç½®ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Code    â”‚
â”‚   å®¢æˆ·ç«¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Anthropic API Request
         â”‚ (messages + tools)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         cc-proxy (deno-proxy)           â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. Prompt Injection              â”‚ â”‚
â”‚  â”‚     - å·¥å…·å®šä¹‰ â†’ XML æç¤ºè¯       â”‚ â”‚
â”‚  â”‚     - å†å²æ¶ˆæ¯æ–‡æœ¬åŒ–              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  2. Protocol Adapter              â”‚ â”‚
â”‚  â”‚     - æ˜ å°„åˆ° OpenAI/Anthropic     â”‚ â”‚
â”‚  â”‚     - æ¸ é“è·¯ç”±                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3. Upstream Forwarder            â”‚ â”‚
â”‚  â”‚     - æµå¼è¯·æ±‚è½¬å‘                â”‚ â”‚
â”‚  â”‚     - è¶…æ—¶ä¸é‡è¯•                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ OpenAI/Anthropic Request
                   â”‚ (çº¯æ–‡æœ¬ï¼Œæ— å·¥å…·å­—æ®µ)
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ä¸Šæ¸¸ AI æœåŠ¡   â”‚
         â”‚  (GPT-4/Claude)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ SSE Stream
                  â”‚ (å« XML å·¥å…·è°ƒç”¨)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         cc-proxy (deno-proxy)           â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  4. Stream Parser                 â”‚ â”‚
â”‚  â”‚     - æ£€æµ‹è§¦å‘ä¿¡å·                â”‚ â”‚
â”‚  â”‚     - è§£æ XML å·¥å…·è°ƒç”¨           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  5. Claude Writer                 â”‚ â”‚
â”‚  â”‚     - ç”Ÿæˆæ ‡å‡† Claude SSE         â”‚ â”‚
â”‚  â”‚     - Tool use/result å°è£…        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Claude API Response
                   â”‚ (tool_use messages)
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Claude Code    â”‚
         â”‚    å®¢æˆ·ç«¯       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ¨¡å—è¯´æ˜

1. **`prompt_inject.ts`**: å·¥å…·æ¨¡æ‹Ÿçš„æ ¸å¿ƒã€‚å°†å·¥å…·å®šä¹‰è½¬åŒ–ä¸º XML æç¤ºè¯ï¼Œå¹¶å°†å†å²å·¥å…·æ¶ˆæ¯"é€€åŒ–"ä¸ºçº¯æ–‡æœ¬ã€‚

2. **`parser.ts`**: æ™ºèƒ½è§£æå™¨ã€‚å®æ—¶ç›‘æ§ä¸Šæ¸¸è¾“å‡ºæµï¼Œè¯†åˆ«è§¦å‘ä¿¡å·å¹¶æ‹¦æˆªæå– XML å·¥å…·è°ƒç”¨æŒ‡ä»¤ã€‚

3. **`claude_writer.ts`**: æ ‡å‡†è¾“å‡ºå™¨ã€‚å°† Parser ç”Ÿæˆçš„äº‹ä»¶ï¼ˆæ–‡æœ¬ã€æ€è€ƒã€å·¥å…·è°ƒç”¨ï¼‰å°è£…æˆæ ‡å‡†çš„ Claude SSE æ ¼å¼ã€‚

4. **`map_claude_to_openai.ts`**: åè®®é€‚é…å™¨ã€‚å°†å¢å¼ºåçš„è¯·æ±‚æ˜ å°„ä¸º OpenAI æ ¼å¼çš„æ¶ˆæ¯æ•°ç»„ã€‚

5. **`upstream.ts`**: ä¸Šæ¸¸è½¬å‘å™¨ã€‚ç»Ÿä¸€å¤„ç† OpenAI å’Œ Anthropic åè®®çš„æµå¼è¯·æ±‚ã€‚

6. **`config.ts`**: é…ç½®ç®¡ç†å™¨ã€‚ä»ç¯å¢ƒå˜é‡åŠ è½½æ¸ é“é…ç½®å’Œå…¨å±€è®¾ç½®ã€‚

## API ç«¯ç‚¹

### POST /v1/messages

Claude Code å…¼å®¹çš„æ¶ˆæ¯ç«¯ç‚¹ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨ã€‚

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
  "model": "my_openai+gpt-4o",
  "messages": [
    {"role": "user", "content": "What's the weather in San Francisco?"}
  ],
  "tools": [
    {
      "name": "get_weather",
      "description": "Get current weather",
      "input_schema": {
        "type": "object",
        "properties": {
          "city": {"type": "string", "description": "City name"}
        },
        "required": ["city"]
      }
    }
  ],
  "max_tokens": 1024
}
```

**å“åº”**: SSE æµå¼å“åº”ï¼ŒåŒ…å« `message_start`, `content_block_start`, `content_block_delta`, `message_delta`, `message_stop` ç­‰äº‹ä»¶ã€‚

### POST /v1/messages/count_tokens

Token è®¡æ•°ç«¯ç‚¹ï¼Œç”¨äºä¼°ç®—è¯·æ±‚çš„ token æ¶ˆè€—ã€‚

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
  "model": "claude-3-sonnet-20240229",
  "messages": [
    {"role": "user", "content": "Hello, world"}
  ]
}
```

**å“åº”**:

```json
{
  "input_tokens": 135,
  "output_tokens": null
}
```

### GET /healthz

å¥åº·æ£€æŸ¥ç«¯ç‚¹ã€‚

**å“åº”**:

```json
{
  "status": "ok"
}
```

## éƒ¨ç½²æŒ‡å—

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t cc-proxy:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name cc-proxy \
  -p 3456:3456 \
  -e ADMIN_API_KEY=your-secure-admin-key \
  -v $(pwd)/config.json:/app/config.json \
  --restart unless-stopped \
  cc-proxy:latest

# è®¿é—®ç®¡ç†åå°è¿›è¡Œé…ç½®
# http://localhost:3456/admin
```

**ä½¿ç”¨ PostgreSQL å­˜å‚¨**:

```bash
docker run -d \
  --name cc-proxy \
  -p 3456:3456 \
  -e ADMIN_API_KEY=your-secure-admin-key \
  -e PGSTORE_DSN=postgresql://user:pass@postgres:5432/cc_proxy \
  --restart unless-stopped \
  cc-proxy:latest
```

### Docker Compose éƒ¨ç½²

```bash
# ç¼–è¾‘ docker-compose.yml é…ç½®ç¯å¢ƒå˜é‡
nano docker-compose.yml

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

è¯¦ç»†çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—è¯·å‚è€ƒ [éƒ¨ç½²æ–‡æ¡£](docs/deno-deployment-guide.md)ï¼ŒåŒ…æ‹¬ï¼š

- systemd æœåŠ¡é…ç½®
- åå‘ä»£ç†è®¾ç½®
- SSL/TLS é…ç½®
- æ—¥å¿—è½®è½¬
- ç›‘æ§å‘Šè­¦

## æ–‡æ¡£ç´¢å¼•

### æ ¸å¿ƒæ–‡æ¡£

- ğŸ“˜ [æ¶æ„è®¾è®¡](docs/pipeline.md) - è¯¦ç»†çš„æ¶æ„è®¾è®¡å’Œå·¥ä½œæµç¨‹
- ğŸ“— [å¼€å‘è®¡åˆ’](docs/deno-server-plan.md) - é¡¹ç›®å¼€å‘è·¯çº¿å›¾å’Œå®æ–½è®¡åˆ’
- ğŸ“™ [ä½¿ç”¨ç¤ºä¾‹](docs/deno-server-examples.md) - å®Œæ•´çš„ç«¯åˆ°ç«¯è¯·æ±‚å“åº”ç¤ºä¾‹
- ğŸ“• [è¿ç»´æ‰‹å†Œ](docs/deno-server-runbook.md) - è¿ç»´æ“ä½œæŒ‡å—

### åŠŸèƒ½æ–‡æ¡£

- ğŸ”¢ [Token è®¡æ•°](docs/TOKEN_COUNTING.md) - Token è®¡æ•°åŠŸèƒ½è¯¦è§£
- ğŸ“ [æ—¥å¿—é…ç½®](docs/logging-configuration.md) - æ—¥å¿—ç³»ç»Ÿé…ç½®è¯´æ˜

### éƒ¨ç½²æ–‡æ¡£

- ğŸš€ [éƒ¨ç½²æŒ‡å—](docs/deno-deployment-guide.md) - å®Œæ•´çš„éƒ¨ç½²æŒ‡å—
- ğŸ“¦ [æ–‡æ¡£å¯¼èˆª](docs/README.md) - æ–‡æ¡£ä¸­å¿ƒå’Œå¿«é€Ÿå¯¼èˆª

## æ•…éšœæ’é™¤

### å·¥å…·ä¸è§¦å‘

**å¯èƒ½åŸå› **:
- ä¸Šæ¸¸æ¨¡å‹çš„ä¸Šä¸‹æ–‡é•¿åº¦ä¸è¶³
- æ¨¡å‹çš„æŒ‡ä»¤éµå¾ªèƒ½åŠ›è¾ƒå¼±
- `max_tokens` è®¾ç½®è¿‡å°

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨æŒ‡ä»¤éµå¾ªèƒ½åŠ›æ›´å¼ºçš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ã€Claude 3.5ï¼‰
- å¢åŠ  `max_tokens` è‡³ 1024 ä»¥ä¸Š
- æ£€æŸ¥æ—¥å¿—ä¸­çš„è§¦å‘ä¿¡å·æ˜¯å¦è¢«æ­£ç¡®è¯†åˆ«

### åè®®æŠ¥é”™

**å¯èƒ½åŸå› **:
- `CHANNEL_n_PROTOCOL` ä¸ `BASE_URL` ä¸åŒ¹é…
- ç«¯ç‚¹åœ°å€é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤ Anthropic åè®®ä½¿ç”¨ `v1/messages` ç«¯ç‚¹
- ç¡®è®¤ OpenAI åè®®ä½¿ç”¨ `v1/chat/completions` ç«¯ç‚¹
- æ£€æŸ¥æ—¥å¿—ä¸­çš„ä¸Šæ¸¸å“åº”çŠ¶æ€ç 

### Token è®¡æ•°ä¸å‡†ç¡®

**å¯èƒ½åŸå› **:
- æœªé…ç½® Claude API Key
- æœ¬åœ° tiktoken ç®—æ³•ä¸å®˜æ–¹æœ‰å·®å¼‚

**è§£å†³æ–¹æ¡ˆ**:
- é…ç½® `CLAUDE_API_KEY` ä½¿ç”¨å®˜æ–¹ API
- è°ƒæ•´ `TOKEN_MULTIPLIER` è¡¥å¿å·®å¼‚
- å‚è€ƒ [Token è®¡æ•°æ–‡æ¡£](docs/TOKEN_COUNTING.md)

### æ›´å¤šé—®é¢˜

å¦‚é‡åˆ°å…¶ä»–é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æœåŠ¡æ—¥å¿—ï¼š`LOG_LEVEL=debug` å¼€å¯è¯¦ç»†æ—¥å¿—
2. æŸ¥çœ‹ [Issues](https://github.com/Passerby1011/cc-proxy/issues)
3. æäº¤æ–° Issue å¹¶é™„ä¸Šè¯¦ç»†æ—¥å¿—

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ã€æ–‡æ¡£æˆ–æå‡ºå»ºè®®ï¼

### å¼€å‘æµç¨‹

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/amazing-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -m 'Add amazing feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/amazing-feature`
5. æäº¤ Pull Request

### ä»£ç è§„èŒƒ

- ä½¿ç”¨ TypeScript ç¼–å†™ä»£ç 
- éµå¾ª Deno å®˜æ–¹ä»£ç é£æ ¼
- æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£
- ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

### æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
deno test --allow-env --allow-net

# è¿è¡Œé›†æˆæµ‹è¯•
./scripts/test-proxy.sh
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è‡´è°¢

- æ„Ÿè°¢ [Anthropic](https://www.anthropic.com/) æä¾› Claude API
- æ„Ÿè°¢ [Deno](https://deno.land/) æä¾›ä¼˜ç§€çš„è¿è¡Œæ—¶
- æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…çš„æ”¯æŒ

---

**Made with â¤ï¸ by the cc-proxy team**
